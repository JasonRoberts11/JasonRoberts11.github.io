<!DOCTYPE html>
<html>
    <head>
        <title>MKR - EVILGOBLINS</title>
        <script type="text/javascript" src="frame.js"></script>
    </head>
    <body style="margin:0;padding:0;" onresize="upScr()">
        <!--<p>HI!</p>-->
        <canvas id="all" width="0" height="0"></canvas>
        <script>
console.log(rgbToString([255,255,255,255]))
            var canvas = document.getElementById("all");
            var scrwid =window.innerWidth-10;
            var scrhig=window.innerHeight-10;
            canvas.getAttributeNode("width").value=scrwid;
            canvas.getAttributeNode("height").value=scrhig;
            var ctx = canvas.getContext("2d");
            //ctx.imageSmoothingEnabled = false;

            ctx.fillStyle="#FF0000";
            ctx.fillText("stupid",100,100);
            //var img = new Image();
            //img.src = 'thehek.png';
            ////RIGHT CLICK
			canvas.addEventListener('contextmenu',function(e){
				e.preventDefault();
			});
            ////MOUSE SUPPORT
            var mouseX;
            var mouseY;
            var mousedown;
			var scroll=0;
            var click=false;
			var mouseButton=0;
            canvas.addEventListener('mousemove',setMouse);
            canvas.addEventListener('mousedown',setMouseDown);
            canvas.addEventListener('mouseup',setMouseUp);
			canvas.addEventListener('wheel',setWheel)
            //canvas.addEventListener('mousedown',click);
            //canvas.addEventListener('mouseup',cluck);
            function setMouse(e){
				e.preventDefault();
                mouseX=e.layerX;
                mouseY=e.layerY;
                fDraw.mouse();
            }
            function setMouseDown(e){
				mouseButton=e.button;
				e.preventDefault();
                mousedown=true;
                click=true;
                fDraw.mouse();
                click=false;
                //console.log("hey");
            }
            function setMouseUp(e){
				e.preventDefault();
                mousedown=false;
                click=true;
                fDraw.mouse();
                click=false;
                //console.log("hi");
            }
			function setWheel(e){
				//console.log(e.deltaY);
				scroll=e.deltaY;
				fDraw.mouse();
				scroll=0;
				
			}
            ////TOUCH SUPPORT
			var dzoom=1;
			var ddist=10;
            canvas.addEventListener('touchmove',setTouch);
            canvas.addEventListener('touchstart',setTouchDown);
            canvas.addEventListener('touchend',setTouchUp);
            function setTouch(e){
                    e.preventDefault();
                if(e.touches.length==1){
                    mouseX=e.touches[0].pageX;
                    mouseY=e.touches[0].pageY;
                    fDraw.mouse();
                }
				if(e.touches.length==2){
					mouseX=(e.touches[0].pageX+e.touches[1].pageX)/2;
					mouseY=(e.touches[0].pageY+e.touches[1].pageY)/2;
					var ndist=dist2(e.touches[0].pageX,e.touches[0].pageY,e.touches[1].pageX,e.touches[1].pageY);
					dzoom=ndist/ddist;
						ddist=ndist;
				}
            }
            function setTouchDown(e){
                e.preventDefault();
                if(e.touches.length==1){
                    mouseX=e.touches[0].pageX;
                    mouseY=e.touches[0].pageY;
                    mousedown=true;
                    click=true;
                    fDraw.mouse();
                    click=false;
                }
				if(e.touches.length==2){
					mousedown=false;
					mouseX=(e.touches[0].pageX+e.touches[1].pageX)/2;
					mouseY=(e.touches[0].pageY+e.touches[1].pageY)/2;
					dzoom=1;
					ddist=dist2(e.touches[0].pageX,e.touches[0].pageY,e.touches[1].pageX,e.touches[1].pageY);
				}
            }
            function setTouchUp(e){
                e.preventDefault();
                    mousedown=false;
                    click=true;
                    fDraw.mouse();
                    click=false;
            }
            
            ////DRAWING ALL SCREEN
            var fDraw;var fTop;var fMain;
            var fStates;var fFrames;var fMid;
            var fSide;var fColor;var fPics;
            var fCanvas;var fTools;
            fDraw = new Frame("",0,"v","even",0);
            fTop = new Frame("This is the top",0,"h","p30",6);
            fMain = new Frame("",0,"h","even",2);
            fStates = new Frame("States",4,"v","a20",2);
            fFrames = new Frame("Frames",5,"v","a20",2);
            fMid = new Frame("Canvas",2,"v","even",0);
            fSide = new Frame("",1,"v","a50",0);
            fPics = new Frame("Pics",1,"v","even",6);
            fColor = new Frame("Color",6,"h","even",6);
            fCanvas = new Frame("Canvas",2,"h","even",6);
            fTools = new Frame("Tools",3,"h","a16",6);
            fDraw.add(fTop);
            fDraw.add(fMain);
            fMain.add(fStates);
            fMain.add(fFrames);
            fMain.add(fMid);
            fMain.add(fSide);
            fSide.add(fPics);
            fSide.add(fColor);
            fMid.add(fCanvas);
            fMid.add(fTools);
            //CANVAS TOOLS:
            var tool = 0;
            var tPencil = new Frame("Pencil",3,"h","a100",6);
            var tEraser = new Frame("Eraser",3,"h","a100",6);
            var tHand = new Frame("Hand",3,"h","a100",6);
            var tUndo = new Frame("Undo",3,"h","a100",6);
            var tLighten = new Frame("Lighten",3,"h","a100",6);
            
            var sprtsimg = new Image;
            sprtsimg.src = 'sprites.png';
            sprtsimg.onload=function(){
                
                tPencil.setImg(getImageFrom(sprtsimg,0,0,13,13));
                tEraser.img=getImageFrom(sprtsimg,0,16,13,13);
                tHand.img=getImageFrom(sprtsimg,0,16*2,13,13);
                tUndo.img=getImageFrom(sprtsimg,0,16*3,13,13);
                tLighten.img=getImageFrom(sprtsimg,0,16*4,13,13);
                fDraw.render(0,0,scrwid,scrhig,0);
            }
            fTools.add(tPencil);
            fTools.add(tEraser);
            fTools.add(tHand);
            fTools.add(tUndo);
            fTools.add(tLighten);
            tPencil.mouseclick=function(){
                //console.log("clicked");
                tool = 0;
            }
            tEraser.mouseclick=function(){
                tool = 1;
            }
            
            
            //CANVAS FOR DRAWING!!!
			fCanvas.stretch=false;
            var zoom=10;
            var kanvsx=32;
            var kanvsy=32;
            var board=genArray(kanvsx,kanvsy,0);
            var kanv = document.createElement("canvas");
            var ktx = kanv.getContext('2d');
			var cdx=Math.floor((kanv.width-kanvsx)/2);
            var cdy=Math.floor((kanv.height-kanvsy)/2);
			var startscroll=0;
			var startx=0;
			var starty=0;
			var starx=0;
			var stary=0;
            kanv.width=50;
            kanv.height=50;
			fCanvas.mousescroll=function(dy){
				if(dy>0&&zoom+dy<40){
					zoom+=dy;
					cdx-=dy;
					cdy-=dy;
				}
				if(dy<0&&zoom+dy>2){
					zoom+=dy;
					cdx-=dy;
					cdy-=dy;
				}
			}
            fCanvas.mouseover=function(x,y){
                kanv.width=fCanvas.xs/zoom;
                kanv.height=fCanvas.ys/zoom;
				if(kanvsx*zoom<fCanvas.xs&&kanvsy*zoom<fCanvas.ys){
                	cdx=Math.floor((kanv.width-kanvsx)/2);
                	cdy=Math.floor((kanv.height-kanvsy)/2);
				}else{
					
				}
                var px=Math.floor(x/zoom-cdx);
                var py=Math.floor(y/zoom-cdy);
				
                ktx.fillStyle="#FFFFFF";
                ktx.fillRect(cdx,cdy,kanvsx,kanvsy);
                ktx.fillStyle="#CCCCCC";
                
                for(i=0;i<kanvsx;i++){
                    for(j=0;j<kanvsy;j++){
                        if(board[i][j]==0){
                            ktx.fillStyle="#CCCCCC";
                        if((i+j)%2==0)
                        	ktx.fillRect(i+cdx,j+cdy,1,1);
                        }else{
                            ktx.fillStyle="#000000";
                            ktx.fillRect(i+cdx,j+cdy,1,1)
                        }
                    }
                }
                ktx.fillStyle="#44444444";
                ktx.fillRect(px+cdx,py+cdy,1,1);
                ktx.imageSmoothingEnabled = false;

                fCanvas.img=kanv;
                fCanvas.render(fCanvas.x,fCanvas.y,fCanvas.xs,fCanvas.ys);
                console.log("X: "+px+" Y:"+py);
                //DRAWING
                if(mousedown&&px>=0&&px<kanvsx&&py>=0&&py<kanvsy){
					if(mouseButton==0){
                    	if(tool==0)
							board[px][py]=1;
						if(tool==1)
							board[px][py]=0;
					}
					if(mouseButton==2){
						board[px][py]=0;
					}
                }
				if(mousedown&&mouseButton==1&&startscroll==0){
					starx=cdx;
					stary=cdy;
					startx=mouseX;
					starty=mouseY;
					startscroll=1;
				}
				if(mousedown&&mouseButton==1&&startscroll==1){
					cdx=starx+Math.floor((mouseX-startx)/zoom);
					cdy=stary+Math.floor((mouseY-starty)/zoom);
				}
				if(!mousedown){startscroll=0;}
                
                //ctx.drawImage(tPencil.img,fCanvas.x+x,fCanvas.y+y-20,20,20);
            };
            fDraw.mouseover=function(x,y){
                //var col = ctx.getImageData(x,y,1,1).data;
                //console.log(col);
            }
            upScr();
            
            
            
            
            
            function upScr(){
                scrwid=window.innerWidth-4;
                scrhig=window.innerHeight-4;
                canvas.getAttributeNode("width").value=scrwid;
                canvas.getAttributeNode("height").value=scrhig;
                ctx.fillStyle="#FF0000";
                ctx.strokeStyle="#00FF00"
                ctx.scale(1,1);
                //img.src="sprites.png";
                //ctx.drawImage(getImageFrom("sprites.png",0,0,104,104),10,10,104,104);
                //ctx.drawImage(img, 10, 10);
                fDraw.render(0,0,scrwid,scrhig,0);
            }
            
            //var canvastmp = document.createElement('canvas');
            function getImageFrom(src,x,y,xs,ys){
                var img = src;
                var canvastmp = document.createElement('canvas');
                canvastmp.width=xs;
                canvastmp.height=ys;
                canvastmp.getContext('2d').imageSmoothingEnabled = false;

                canvastmp.getContext('2d').drawImage(img,-x,-y,img.width,img.height);
                //var newimg = new Image();
                //newimg.src=canvastmp.toDataURL("image/png");
                return canvastmp;
            }
            function stretchImage(src,xs,ys){
                var canvastmp=document.createElement('canvas');
                var num = Math.floor(xs/src.width);
                if(num>Math.floor(ys/src.height)){
                    num=Math.floor(ys/src.height);
                }
                var exs = src.width*num;
                var eys = src.height*num;
                canvastmp.width=exs;
                canvastmp.height=eys;
                var ttx = canvastmp.getContext('2d');
                for(var i = 0;i<src.width;i++){
                    for(var j=0;j<src.height;j++){
                        var col = src.getContext('2d').getImageData(i,j,1,1).data;
                        ttx.fillStyle=rgbToString(col);
                        ttx.fillRect(i*num,j*num,num,num);
                    }
                }
                return canvastmp;
            }
            function rgbToString(parts){
                 r = parseInt((parts[0]), 10),
                g = parseInt((parts[1]), 10),
                b = parseInt((parts[2]), 10),
                a = parseInt(parts[3],10);
//console.log(parts);
    return ('#' + r.toString(16) + g.toString(16) + b.toString(16) + (a ).toString(16));
                
            }
            function genArray(row,col,val)
{
  var a=[];
  for (var i=0;i<row;i++){
    var b = [];
    for (var j=0;j<col;j++){
      b.push(eval(String(val)));
    }
    a.push(b);
  }
  return a;
}
			function dist2(x,y,x2,y2){
                return (Math.pow((Math.pow((x-x2),2)+Math.pow((y-y2),2)),0.5));
            }
        </script>
    </body>
</html>