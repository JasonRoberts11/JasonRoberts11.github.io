<!DOCTYPE html>
<html>
    <head>
        <title id="title">THIS IS GOOD</title>
        <link id="icon" rel="icon" href="icon1.png">
    </head>
    <body>
        <h1 id="head">JASN 188</h1>
        <p><i>There are some <strong>bugs</strong> in here</i></p>
        <p id = "output"></p>
        <button id ="test">TEST</button><br/>
        <canvas id="main" width="500" height="500">
        </canvas>
        
        <script>
            var main = document.getElementById("main");
            var ctx = main.getContext("2d");
            var scrwid =800;
            var scrhig=800;
            
            main.getAttributeNode("width").value=scrwid;
            main.getAttributeNode("height").value=scrhig;
            
            var title = document.getElementById("title");
            var icon = document.getElementById("icon");
            var head = document.getElementById("head");
            var output = document.getElementById("output");
            var testButton = document.getElementById("test");
            testButton.onclick = function test(){
                //addElement(1,200,200);
                //updateMaxLayer();
                addElement(main,1,1,0,0);
            }
            icond=1;
            var iconchanger=setInterval(function(){
                icon.getAttributeNode("href").value = "icon"+icond+".png";
                icond=(icond%2)+1;
            },1000)
            
            
            
            var mousex;
            var mousey;
            var mdx = 0;
            var mdy = 0;
            var mousepressed=0;
            var upmos=0;
            function setMouse(event){
                mdx = event.layerX-mousex;
                mdy = event.layerY-mousey;
                mousex = event.layerX;
                mousey = event.layerY;
                //if(mousepressed==1||upmos<10){
                if(picked==-1){
                    //setSelection();
                }else{
                    //setOver();
                }
                output.innerHTML="Mouse: " +mousex+ " "+mousey+"   Selected: "+ selected;
                /*if(selected!=-1){
                   output.innerHTML+=" Parent: "+ elements[selected][1];
                    output.innerHTML+=" Children: " +elements[selected][2];
                    output.innerHTML+=" Layer: "+ elements[selected][8];
                }*/
                update();
                title.innerHTML= Math.floor(Math.random()*1000)+" Ways to Fail"
                //}
            }
            function click(event){
                mousepressed=1;
                update();
            }
            function cluck(event){
                upmos=0;
                mousepressed=2;
                update();
            }
            main.addEventListener('mousemove',setMouse);
            main.addEventListener('mousedown',click);
            main.addEventListener('mouseup',cluck)
            
            offcan = document.createElement('canvas');
            offcan.width = scrwid;
            offcan.height= scrhig;
            offctx = offcan.getContext('2d');
            function renderOffCan(i){
                for(k=0;k<elements[i][2].length;k++){
                    rendChild(i);
                }
            }
            function rendChild(i){
                p=elements[i][1];
                for(var k = 0;k<elements[i][2].length;k++){
                    rendChild(elements[i][2][k]);   
                }
            }
            
            
            var elements = new Array(0);
            var maxlayer = 0;
            var selected;
            var picked;
            var over;
            var seldat =-1;
            var selrad = 10;
            var defsize = 25;
            var colorblocks = new Array([100,150,200],[200,100,150]);
            
            //THE STRUCTURE FOR THE Element OBject
            //Absolutes then the easily changed...
            // 0type, 1parent, 2children[], 3local xpos, 4local ypos, 5connections[],  6abs xpos, 7abs ypos, 8layer , 9size,10 open?
            
            
            
            //OBjECT
            function element(i,type,xpos,ypos){
                this.x = xpos;
                this.y = ypos;
                this.absx = xpos;
                this.absy = ypos;
                this.type = type;
                this.parent = null;
                this.children = [];
                this.id = i;
                this.color = 0;
                this.layer=0;
                this.size = defsize;
                this.open = true;
                this.connections = [];
                this.render = function(){
                    var t = 1;
                    var s = 1;
                    ctx.fillStyle= tint(colorblocks[this.color],t);
                    ctx.strokeStyle=tint(colorblocks[this.color],0.6*s);
                    ctx.lineWidth = s*2;
                    ctx.beginPath();
                    ctx.arc(this.absx,this.absy,this.size,0,2*Math.PI);
                    ctx.fill();
                    ctx.stroke();
                    for(var i =0;i<this.children.length;i++){
                        this.children[i].render();
                    }
                };
                this.add = function(e){
                    this.children.push(e);
                };
            }
            var maine = new element(0,1,250,250);
            maine.size = 250;
            maine.color = 1;
            //console.log(bob.type);
            
            //TYPE STRUCTURES
            // type: 1 
            //  A basic circle
            
            
            
            /**for(var i = 0; i < 100; i++){
                elements[i] = new Array(Math.random()*100,Math.random()*100);
            }
            for(var i = 0; i < 100; i++){
                ctx.fillStyle ='rgb(0,0,'+i*10+')';
                ctx.beginPath();
                ctx.arc(elements[i][0]+250,elements[i][1]+250,10,0,2*Math.PI);
                ctx.fill();
                ctx.stroke();
            }**/
            //var uptimer = setInterval(function(){update()},100);
            var upmostim = setInterval(function(){upmos++;},100);
            function update(){
                head.innerHTML="JASN "+(Math.floor(Math.random()*1000));
                maine.render();
                
            }
            
            function addElement(parent,i,type,x,y){
                var e = new element(i,type,x,y);
                e.absx = maine.absx+x;
                e.absy = maine.absy+y;
                maine.add(e);
            }
            
            
            //ALL THIS CODE IS DEPRICATED
            /*function update(){
                head.innerHTML="JASN "+(Math.floor(Math.random()*1000));
                renderElements();
                dragger();
            }
            function addElement(type,xpos,ypos){
                elements.push(new Array(type,-1,new Array(),xpos,ypos,new Array(),xpos,ypos,maxlayer,defsize,true));
            }
            function renderElements(){
                ctx.clearRect(0,0,scrwid,scrhig);
                for(var layer = 0;layer<maxlayer+1;layer++){
                    for(i= 0;i<elements.length;i++){
                        if(elements[i][8]==layer){
                        if(i==selected){
                            if(seldat==1){
                                displayElement(elements[i],1.2,1);
                            }else{
                                displayElement(elements[i],1,2)
                            }
                        }else if(over==i){
                            displayElement(elements[i],0.8,1);   
                        }else{
                            displayElement(elements[i],1,1);
                        }
                        }
                    }
                }
            }
            function setSelection(){
                selected=-1;
                for(var layer = 0;layer<maxlayer;layer++){
                    for(i= 0;i<elements.length;i++){
                        if(elements[i][8]==layer){
                            e=elements[i];
                            if(dist(e[6],e[7],mousex,mousey,e[9])){
                                if(dist(e[6],e[7],mousex,mousey,e[9]-selrad)){
                                    seldat=1;
                                }else{
                                    seldat=-1;
                                }
                                selected=i;
                            }
                        }
                    }
                }
            }
            function setOver(){
                over=-1;
                for(var layer = 0;layer<maxlayer;layer++){
                    for(i= 0;i<elements.length;i++){
                        if(elements[i][8]==layer){
                            e=elements[i];
                            if(i!=picked){
                                if(dist(e[6],e[7],mousex,mousey,e[9])){
                                    over=i;
                                }
                            }
                        }
                    }
                }
            }
            function drop(p,c){
                elements[p][2].push(c);
                elements[c][1]=p;
                elements[c][3]=-elements[p][6]+elements[c][6];
                elements[c][4]=-elements[p][7]+elements[c][7];
                elements[c][8]=elements[p][8]+1;
                d=dist2(elements[p][6],elements[p][7],elements[c][6],elements[c][7]);
                    if(elements[p][9]<d+elements[c][9]){
                    elements[p][9] = d+elements[c][9];
                }
            }
            var pik=0;
            function dragger(){
                if(selected!=-1){
                    if(seldat==1){
                        if(mousepressed==1){
                            picked=selected;
                        }
                    }
                }
                if(picked!=-1){
                    if(pik==0){
                        elements[picked][8]=maxlayer;
                        p=elements[picked][1];
                        if(p!=-1){
                            arr = elements[p][2];
                            index = arr.indexOf(picked);
                            if(index>-1){
                                elements[p][2].splice(index,1)
                            }
                            elements[picked][1]=-1;
                        }
                        //updatelayers();
                        pik=1;
                    }
                    if(mousepressed==1){
                        elements[picked][6]+=mdx;
                        elements[picked][7]+=mdy;
                        elements[picked][3]+=mdx;
                        elements[picked][4]+=mdy;
                        updateAbsPos(picked);
                    }
                    if(mousepressed==2){
                        if(over!=-1){
                           drop(over,picked);
                            updateMaxLayer();    
                        }else{
                           elements[picked][8]=0;
                            elements[picked][1]=-1;
                           }
                        if(pik == 1){
                            updateAbsPos(picked);
                            pik=0;
                        }
                        picked=-1;
                    }
                }
            }
            function displayElement(e,t,s){
                if(e[0] == 1){
                    ctx.fillStyle= tint(colorblocks[0],t);
                    ctx.strokeStyle=tint(colorblocks[0],0.6*s);
                    ctx.lineWidth = s*2;
                    ctx.beginPath();
                    ctx.arc(e[6],e[7],e[9],0,2*Math.PI);
                    ctx.fill();
                    ctx.stroke();
                }
            }
            
            function updateMaxLayer(){
                for(i= 0;i<elements.length;i++){
                     if(elements[i][8]>=maxlayer){
                         maxlayer=elements[i][8]+1;
                     }   
                }
            }
            function updateAbsPos(i){
                    //if(elements[i][8]==0){
                        for(k = 0;k<elements[i][2].length;k++){
                            upabspos(elements[i][2][k]);
                        }       
                    //}
            }
            function upabspos(i){
                p=elements[i][1];
                elements[i][6]=elements[p][6]+elements[i][3];
                elements[i][7]=elements[p][7]+elements[i][4];
                for(var k = 0;k<elements[i][2].length;k++){
                    upabspos(elements[i][2][k]);   
                }
            }
*/
            function dist(x,y,x2,y2,r){
                if(Math.pow((x-x2),2)+Math.pow((y-y2),2)<Math.pow(r,2)){
                    return true;
                }else{
                    return false;
                }
            }
            function dist2(x,y,x2,y2){
                return (Math.pow((Math.pow((x-x2),2)+Math.pow((y-y2),2)),0.5));
            }
            function tint(color,tint){
                return("rgb("+color[0]*tint+","+color[1]*tint+","+color[2]*tint+")");
            }
        
        </script>
        
        
        
    </body>
</html>