<!DOCTYPE html>
<html>
    <head>
        <title id="title">THIS IS GOOD</title>
        <link id="icon" rel="icon" href="icon1.png">
        <meta name="viewport" content="width=device-width,user-scalable=no">

    </head>
    <body style="margin:0;padding:0;" onresize="upScr()">
        <!--<h1 id="head">JASN 188</h1>
        <p><i>There are some <strong>bugs</strong> in here</i></p>
        <p id = "output"></p>
        <button id ="test">TEST</button><br/>-->
        <div>
        <canvas id="main" width="500" height="500" style="margin:0;padding:0;position:fixed;top:0;left:0;">
            </canvas></div>
        <!--<div style="position:fixed;bottom:0;border:1px solid black;max-height: 200px;margin:auto;">
        <div id="preview">
            </div>
            </div>-->
        <script type="text/javascript" src="d_html.json"></script>
        <script>
					var mode = "zubble";
			
			
            var main = document.getElementById("main");
            var preview = document.getElementById("preview");
            var ctx = main.getContext("2d");
            var scrwid =window.innerWidth-10;
            var scrhig=window.innerHeight-10;
            main.getAttributeNode("width").value=scrwid;
            main.getAttributeNode("height").value=scrhig;
            
            var title = document.getElementById("title");
            var icon = document.getElementById("icon");
            /*var head = document.getElementById("head");
            var output = document.getElementById("output");
            var testButton = document.getElementById("test");
            testButton.onclick = function test(){
                //addElement(1,200,200);
                //updateMaxLayer();
                addElement(maine,1,1,0,0);
            }*/
            icond=1;
			var tby =30;
			function upScr(){
                scrwid =window.innerWidth-5;
                scrhig=window.innerHeight-5;
                if(scrwid <scrhig){
                     maine.size = scrwid/2;
				maine.absx = scrwid/2;
				maine.absy = scrwid/2+tby;
                       
                   sbhig=scrhig;
			         sbx=0;
                    side=false;
                    main.getAttributeNode("width").value=scrhig;
            main.getAttributeNode("height").value=scrhig;
                }else{
     maine.size = (scrhig-2*tby)/2;
				maine.absx = (scrhig-tby*2)/2;
				maine.absy = (scrhig-2*tby)/2+tby;
                    sbhig=scrhig;
			sbx=scrwid;
                    
                    side=true;
                    main.getAttributeNode("width").value=scrwid;
            main.getAttributeNode("height").value=scrwid;
                }
				update();
			}
            var iconchanger=setInterval(function(){
                icon.getAttributeNode("href").value = "icon"+icond+".png";
                icond=(icond%2)+1;
            },1000);
            var mousex;
            var mousey;
            var mdx = 0;
            var mdy = 0;
            var mousepressed=0;
            var upmos=0;
             var cdlay = 100;
            var dat = new Date();
            var time= dat.getTime;
            function setMouse(event){
                if(true){
                   main.focus();
                   }
                var dt = new Date().getTime()-time;
                if(mousepressed==1&&dt>cdlay){
                mousepressed=2;
                    //console.log(mousepressed+" "+dt);
                }
                if(mousepressed==3&&dt>cdlay){
                mousepressed=4;
                    //console.log(mousepressed+" "+dt);
                }
                mdx = event.layerX-mousex;
                mdy = event.layerY-mousey;
                mousex = event.layerX;
                mousey = event.layerY;
                //if(mousepressed==1||upmos<10){
                if(picked==-1){
                    //setSelection();
                }else{
                    //setOver();
                }
                //output.innerHTML="Mouse: " +mousex+ " "+mousey
                /*if(selected!=-1){
                   output.innerHTML+=" Parent: "+ elements[selected][1];
                    output.innerHTML+=" Children: " +elements[selected][2];
                    output.innerHTML+=" Layer: "+ elements[selected][8];
                }*/
                update();
                title.innerHTML= Math.floor(Math.random()*1000)+" Ways to Fail"
                //}
            }
            function setTouch(event){
                event.preventDefault();
                var dt = new Date().getTime()-time;
                if(mousepressed==1&&dt>cdlay){
                mousepressed=2;
                    //console.log(mousepressed+" "+dt);
                }
                if(mousepressed==3&&dt>cdlay){
                mousepressed=4;
                    //console.log(mousepressed+" "+dt);
                }
                var tou = event.changedTouches;
                if(tou.length==1){
                    var e = main.getBoundingClientRect();
                mdx = tou[0].pageX-e.left-mousex;
                mdy = tou[0].pageY-e.top-mousey;
                mousex = tou[0].pageX-e.left;
                mousey = tou[0].pageY-e.top;
                }
                //if(mousepressed==1||upmos<10){
                if(picked==-1){
                    //setSelection();
                }else{
                    //setOver();
                }
                //output.innerHTML="Mouse: " +mousex+ " "+mousey
                /*if(selected!=-1){
                   output.innerHTML+=" Parent: "+ elements[selected][1];
                    output.innerHTML+=" Children: " +elements[selected][2];
                    output.innerHTML+=" Layer: "+ elements[selected][8];
                }*/
                update();
                title.innerHTML= Math.floor(Math.random()*1000)+" Ways to Fail"
                //}
            }
            function click(event){
                var dt = new Date().getTime()-time;
                if(mousepressed==0){
                mousepressed=1;
                }
                if(dt<cdlay){
                mousepressed=3;
                }
                update();
                
                time=new Date().getTime();
                update();
                //console.log(mousepressed+" "+dt);
                //console.log("click")
            }
            ///MOUSEPRESSED AS FOLLOWS:
            ///0: Not pressed
            ///1: Just Clicked
            ///2: Held Once
            ///3: Clicked twice
            ///4: Held Twice
            function cluck(event){
                var dt = time-dat.getTime();
                upmos=0;
                mousepressed=0;
                //if(mousepressed==1){
                //mousepressed=0;
                //}
                //if(mousepressed==3){
                //mousepressed=0;
                //}
                update();
                time=new Date().getTime();
                update();
                //console.log("cluck")
            }
            function tap(event){
                var tou = event.changedTouches;
                if(tou.length==1){
                    var e = main.getBoundingClientRect();
                mdx = tou[0].pageX-e.left-mousex;
                mdy = tou[0].pageY-e.top-mousey;
                mousex = tou[0].pageX-e.left;
                mousey = tou[0].pageY-e.top;
                }
                event.preventDefault();
                var dt = new Date().getTime()-time;
                if(mousepressed==0){
                mousepressed=1;
                }
                if(dt<cdlay){
                mousepressed=3;
                }
                update();  
                time=new Date().getTime();
            }
            function untap(event){
                event.preventDefault();
                var dt = time-dat.getTime();
                upmos=0;
                mousepressed=0;
                time=new Date().getTime();
                update();
                update();
                //console.log("cluck")
            }
            document.addEventListener('mousemove',setMouse);
            document.addEventListener('mousedown',click);
            document.addEventListener('mouseup',cluck)
            main.addEventListener('touchmove',setTouch,false);
            main.addEventListener('touchstart',tap,false);
            main.addEventListener('touchend',untap,false)
            offcan = document.createElement('canvas');
            offcan.width = scrwid;
            offcan.height= scrhig;
            offctx = offcan.getContext('2d');
            /*function renderOffCan(i){
                for(k=0;k<elements[i][2].length;k++){
                    rendChild(i);
                }
            }*/
            /*function rendChild(i){
                p=elements[i][1];
                for(var k = 0;k<elements[i][2].length;k++){
                    rendChild(elements[i][2][k]);   
                }
            }*/
            
            
            var elements = new Array(0);
            var maxlayer = 0;
            var selected;
            var picked;
            var over;
            var seldat =-1;
            var selrad = 10;
            var defsize = 25;
            var ddde=10;
            var colorblocks = new Array([200,100,150],[100,150,200],[150,200,150],[230,230,230],[230,100,230],[230,220,23],[0,230,230]);
			var parent=null;
            
            //THE STRUCTURE FOR THE Element OBject
            //Absolutes then the easily changed...
            // 0type, 1parent, 2children[], 3local xpos, 4local ypos, 5connections[],  6abs xpos, 7abs ypos, 8layer , 9size,10 open?
            
            
            
            //OBjECT
            function element(i,type,xpos,ypos){
                this.x = xpos;
                this.y = ypos;
				this.close = false;
				this.lx=xpos;
				this.ly=ypos;
				this.xv=2;
				this.yv=0;
                this.absx = xpos;
                this.absy = ypos;
                this.type = type;
                this.js=null;
                this.parent = null;
                this.children = [];
                this.id = i;
                this.color = 0;
                this.tint =1;
				this.label="";
                this.bold = 1;
                this.layer=0;
                this.size = defsize;
                this.open = true;
                this.connections = [];
                this.render = function(){
                    var t = this.tint;
                    var s = this.bold;
                    ctx.fillStyle= tint(colorblocks[this.color],t);
                    ctx.strokeStyle=tint(colorblocks[this.color],0.6*s);
                    ctx.lineWidth = s*2;
                    ctx.beginPath();
                    ctx.arc(this.absx,this.absy,this.size,0,2*Math.PI);
                    ctx.fill();
                    ctx.stroke();
					 ctx.font="10px Arial";
						ctx.textAlign="center";
						ctx.textBaseline="mid";
                        ctx.fillStyle = tint(colorblocks[this.color],0);
						ctx.fillText(this.label,this.absx,this.absy+this.size-10);
					if(this.js!=null&&this.js.name=="raw"){
                        ctx.fillText(this.js.text,this.absx,this.absy);
                    }
					if(!this.close){
                    for(var i =0;i<this.children.length;i++){
                        if(this.children[i].close)
                        this.children[i].render();
                    }
                    for(var i =0;i<this.children.length;i++){
                        if(!this.children[i].close)
                        this.children[i].render();
                    }
                    }else{
                        ctx.font="30px Arial";
						ctx.textAlign="center";
						ctx.textBaseline="mid";
                        ctx.fillStyle = tint(colorblocks[this.color],0);
						ctx.fillText(this.children.length,this.absx,this.absy);
					}
                    
                };
                this.add = function(e){
                    this.children.push(e);
                };
				this.getSelection = function(){
					if(dist(this.absx,this.absy,mousex,mousey,this.size)){
						selected=this;
					}
                    if(!this.close)
					for(i = 0;i<this.children.length;i++){
						this.children[i].getSelection();
					}
				}
				this.phys=function(){
					var p=this.parent;
					//If collides with parent
					if(dist2(this.absx,this.absy,p.absx,p.absy)+(this.size)+ddde*0.5>p.size){
						//var r=Math.atan2(this.yv,this.xv);
						var b=Math.atan2((this.absy-p.absy),(this.absx-p.absx));
						//var g=r-b;
						this.xv -= Math.cos(b)*0.1;
						this.yv -= Math.sin(b)*0.1;
					}
					//If collides with others
					for(var i=0;i<p.children.length-1;i++){
						c = p.children[i];
						if(c!=this){
						if(dist2(this.absx,this.absy,c.absx,c.absy)<c.size+this.size){
							//console.log("collide");
						//var r=Math.atan2(this.yv,this.xv);
						var b=Math.atan2((this.absy-c.absy),(this.absx-c.absx));
						//var g=r-b;
						this.xv += Math.cos(b)*0.1;
						this.yv += Math.sin(b)*0.1;
						c.xv -= Math.cos(b)*0.1;
						c.yv -= Math.sin(b)*0.1;
					}}
					}
					this.fakeMoveChild(this.xv,this.yv);
					
					this.absx+=this.xv;
					this.absy+=this.yv;
					this.xv+=(this.absx-this.lx)*-0.001;
					this.yv+=(this.absy-this.ly)*-0.001;
					this.xv*=0.9;
					this.yv*=0.9;
					
					this.childPhys();
					this.updateSize();
					
				}
				this.fakeMoveChild=function(xv,yv){
					for(var i=0;i<this.children.length;i++){
					this.children[i].absx+=xv;
					this.children[i].absy+=yv;
					this.children[i].lx+=xv;
					this.children[i].ly+=yv;
					this.children[i].fakeMoveChild(xv,yv);
					}
				}
				this.childPhys=function(){
					for(i = 0;i<this.children.length;i++){
						this.children[i].phys();
					}
				}
				this.move = function(dx,dy){
					this.absx += dx;
					this.absy += dy;
					for(var i =0;i<this.children.length;i++){
                        this.children[i].updatePos();
                    } 
				}
                this.togClose=function(){
                    if(this.close){
                        this.close=false;
                        this.updateSize();
                    }else{
                        this.close=true;
                    }
                }
				this.shrinkWrap=function(){
                    if(!this.close)
					for(var i =0;i<this.children.length;i++){
                        this.children[i].shrinkWrap();
                    } 
				}
				this.updatePos = function(){
					if(this.parent!=null){
					this.absx = this.parent.absx + this.x;
					this.absy = this.parent.absy + this.y;}
					this.lx= this.absx;
					this.ly=this.absy;
					for(var i =0;i<this.children.length;i++){
                        this.children[i].updatePos();
                    } 
				}
                this.reOrder=function(){
                    var e = [];
                    for(var i =0;i<this.children.length;i++){
                        c = this.children[i];
                        e.push([c,Math.atan2(c.y,c.x)]);
                    }
                    e.sort(sf);
                    var d = [];
                    for(var i =0;i<e.length;i++){
                        d.push(e[i][0]);
                    }
                    this.children=d;
                    function sf(a,b){
                        if(a[1]===b[1]){
                            return 0;
                        }
                        else{
                            return(a[1]<b[1])?-1:1;
                        }
                    }
                
                }
                this.parse=function(){
                    if(this.js.name=="raw"){
                        par+=this.js.text;
                    }else{
                    par+=this.js.start;
                    this.parseChildren();
                    par+=this.js.end;
                }
                }
                this.parseChildren=function(){
                    for(var i =0;i<this.children.length;i++){
                        this.children[i].parse();
                    } 
                }
                this.updateSize=function(){
                    //this.parent.size=dist2(this.absx,this.absy,this.parent.absx,this.parent.absy)+(this.size)+ddde;
                    if(!this.close){
                    var maxsize = defsize;
                    var chose=-1;
                    for(var i =0;i<this.children.length;i++){
                        this.children[i].updateSize();
                        var c = this.children[i];
                        if(dist2(this.absx,this.absy,c.absx,c.absy)+(c.size)+ddde>maxsize){
                           maxsize=dist2(this.absx,this.absy,c.absx,c.absy)+(c.size)+ddde;
                            
                           }
                    } 
                    this.size=maxsize;
                    }else{
                        this.size=defsize;
                    }
                }
                this.updateChildSize = function(){
                    for(var i =0;i<this.children.length;i++){
                        this.children[i].updateSize();
                    } 
                }
				this.findParent = function(e){
					parent=null;
					e.recFindParent(this);
					if(parent!=null){
						this.parent = parent;
						parent.children.push(this);
						this.x = -this.parent.absx+this.absx;
						this.y = -this.parent.absy+this.absy;
						this.lx = this.absx;
						this.ly = this.absy;
					}
				}
				this.recFindParent = function(c){
					if(this!=c)
					   if(dist(this.absx,this.absy,mousex,mousey,(this.size))){
					   parent = this;
                        if(!this.close)
						for(var i =0;i<this.children.length;i++){
                        this.children[i].recFindParent(c);
                    	} 
					}
				}
				this.removeParent = function(){
					this.parent.children.splice(this.parent.children.indexOf(this),1);
					this.parent = null;
				}
				
				this.orphanize=function(){
					this.parent=null;
					for(var i =0;i<this.children.length;i++){
                        this.children[i].orphanize();
                    } 
				}
				this.deOrphanize=function(){
					
					for(var i =0;i<this.children.length;i++){
						this.children[i].parent = this;
                        this.children[i].deOrphanize();
                    } 
				}
				this.parseToJSON=function(){
					var robj=this.makeJson();
					for(var i =0;i<this.children.length;i++){
						robj.children.push(this.children[i].parseToJSON());
                    }
					//prev.children.push(robj);
					console.log(JSON.stringify(robj));
					return robj;
				}
				this.makeJson= function(){
					var obj = new jsobj();
					obj.x=this.x;
					obj.y=this.y;
					obj.size=this.size;
					obj.js=this.js;
					obj.color =this.color;
					obj.label =this.label;
					obj.close = this.close;
					return obj;
				}
				this.readJson = function(obj){
					this.x = obj.x;
					this.y = obj.y;
					this.size = obj.size;
					this.js = obj.js;
					this.color=obj.color;
					this.label=obj.label;
					this.close = obj.close;
					for(var i =0;i<obj.children.length;i++){
						var ch = new element(null,1,1,1);
						ch.readJson(obj.children[i]);
						this.children.push(ch);
                    }
				}
				this.run = function(){
					//console.log("label:"+this.label);
					if(this.label == "Print"){
						if(this.children.length>0){
							var aaa=this.children[0].eval();
							for(var i =1;i<this.children.length;i++){
								aaa+=this.children[i].eval();
                    		}
							console.log(aaa);
						}
					}else{
						for(var i =0;i<this.children.length;i++){
							this.children[i].run();
                    	}
					}
				}
				this.eval = function(obj){
					var out;
					if(this.label == "raw"){
					   out = this.js.text;
					}
					if(this.label == "+"){
					   out=0;
					for(var i =0;i<this.children.length;i++){
							out+=parseFloat(this.children[i].eval());
                    	}
					}if(this.label == "*"){
					   out=1;
					for(var i =0;i<this.children.length;i++){
							out*=parseFloat(this.children[i].eval());
                    	}
					}
					if(this.label == "-"){
					   out=0;
						for(var i =0;i<Math.floor(this.children.length/2);i++){
							out+=parseFloat(this.children[i].eval());
                    	}
						for(var i =Math.floor(this.children.length/2);i<this.children.length;i++){
							out-=parseFloat(this.children[i].eval());
                    	}
					}
					if(this.label == "/"){
					   out=1;
					for(var i =0;i<Math.floor(this.children.length/2);i++){
							out*=parseFloat(this.children[i].eval());
                    	}
						for(var i = Math.floor(this.children.length/2);i<this.children.length;i++){
							out/=parseFloat(this.children[i].eval());
                    	}
					}
					return out;
				}
				
            }
			function jsobj(){
				this.x;
				this.y;
				this.size;
				this.children = [];
				this.js;
				this.color;
			}
            var maine = new element(null,1,scrwid/2,scrwid/2);
            maine.size = scrwid/2;
            maine.color = 0;
            //console.log(bob.type);
            
            //TYPE STRUCTURES
            // type: 1 
            //  A basic circle
            /**for(var i = 0; i < 100; i++){
                elements[i] = new Array(Math.random()*100,Math.random()*100);
            }
            for(var i = 0; i < 100; i++){
                ctx.fillStyle ='rgb(0,0,'+i*10+')';
                ctx.beginPath();
                ctx.arc(elements[i][0]+250,elements[i][1]+250,10,0,2*Math.PI);
                ctx.fill();
                ctx.stroke();
            }**/
            //var uptimer = setInterval(function(){update()},100);
            var upmostim = setInterval(function(){upmos++;},100);
			
			
			////UPDATE/////////////////////////////////////////////////////////
            function update(){
                //head.innerHTML="JASN "+(Math.floor(Math.random()*1000));
                ctx.clearRect(0,0,scrwid,scrhig);
                maine.render();
				//selected= maine;
				drawSideBar();
				drawTopBar();
				dragger();
				maine.updateChildSize();
            }
			var startphys= window.setInterval(function(){
				maine.childPhys();
				maine.render();
				drawSideBar();
				drawTopBar();
				if(dragged!=null){
				    dragged.render();
                    if(selected!=null)
                    selected.bold=1;
                    selected=null;
                    maine.getSelection();
                    if(selected!=null)
                    selected.bold=2;
				}
				//dragger();
			},10);
            
			
			
			
			
			
            function addElement(parent,i,type,x,y){
                var e = new element(i,type,x,y);
                e.absx = maine.absx+x;
                e.absy = maine.absy+y;
				e.parent = parent;
                maine.add(e);
            }
			function dragElement(e){
				e.move(mdx,mdy);
			}
			dragged = null;
			function dragger(){
                if(mousepressed==3){
                    selected=null;
				    maine.getSelection();
				    if(selected != maine&&selected!=null){
                        if(selected.js!=null&&selected.js.name=="raw"){
                           var r = "";
                            r = prompt("Text?",selected.js.text);
							if(r!=null)
                            selected.js.text=r;
                            selected=null;
                            mousepressed=4;
                           }else{
				        selected.togClose();
                        mousepressed=4;
                        }
                    }
                }
                if(mousepressed==0&&dragged==null){
                    if(selected!=null)
                    selected.tint=1;
                    selected=null;
                    maine.getSelection();
                    if(selected!=null){
                    selected.tint=1.2;
                    selected.reOrder();
                    if(selected.js!=null&&selected.js.name=="html"){
                      parseHtml(selected);  
                    }
                    }
                    
                }
				if(mousepressed==2&&dragged==null){
				selected=null;
				maine.getSelection();
				if(selected != maine&&selected!=null){
				dragged=selected;
                    dragged.tint=1.1;
				dragged.removeParent();}
				}
				if(dragged!=null){
				   dragElement(dragged);
				    dragged.render();
                    if(selected!=null)
                    selected.bold=1;
                    selected=null;
                    maine.getSelection();
                    if(selected!=null)
                    selected.bold=2;
				}
				if(mousepressed==0&&dragged!=null){
                    if(selected!=null)
                    selected.bold=1;
					dragged.findParent(maine);
					dragged.render();
					dragged=null;
				}
			}
				
			
			
			
			function runZubble(){
				for(var i =0;i<maine.children.length;i++){
						var cr = maine.children[i];	
					//console.log(cr.label);
						if (cr.label=="Initialize"){
							cr.run();
							//console.log("Initialized");
						}
                    }
			}
				
				
			///////SIDE BAR////////////////////////////////////////////
			var sbsiz = 100;
			var sbdy=30;
			var sbhig=scrhig;
			var sbx=scrwid;//THe RIGHT SIDE
			var tbs = 30;
			var sby=0+tbs;
			var side=true;
			var mbar = [];
			var sbar = 0;
			if(mode=="html"){
			mbar.push(JSON.parse(d_html));
            mbar.push(JSON.parse(d_javascript));
			}
			mbar.push(JSON.parse(d_zubble));
			var par="";
			var upar="";
			function parseHtml(el){
                par="";
                el.parseChildren();
                //console.log(par);
                preview.innerHTML=par;
            }
			const rb=document.createElement('INPUT');
			rb.setAttribute("type","file");
			rb.style.display='none';
			document.body.appendChild(rb);
			function upload(){
				rb.click();
			}
			rb.addEventListener("change",()=>{
				const file = rb.files.item(0);
				fileToText(file,(text)=>{
					upar=text;
					if(upar.charAt(0)=='{'){
						maine = new element(null,1,0,0);
						maine.readJson(JSON.parse(upar));
						upScr();
						maine.deOrphanize();
						maine.updatePos();
					//maine = JSON.parse(upar);
						//maine.eorphanize();
					}else{
						console.log("failed");
					}
				});
				
			});
			function fileToText(file,callback){
				const reader = new FileReader();
				reader.readAsText(file);
				reader.onload = () =>{
					callback(reader.result);
				}
			}
			function download(name, string){
				var ra = document.createElement('a');
				ra.setAttribute('href','data:text/plain;charset=utf-8,'+encodeURIComponent(string));
				ra.setAttribute('download',name);
				ra.style.display='none';
				document.body.appendChild(ra);
				ra.click();
				document.body.removeChild(ra);
			}
			tbx=100;
			function drawTopBar(){
					ctx.fillStyle="#EEEEEE";
					ctx.fillRect(0,0,scrwid,tby);
					ctx.fillStyle="#444444";
				var sele=-1;
				var tes=["Save","Load","Run"]
				for(var i =0;i<3;i++){
					ctx.fillStyle="#AAAAAA";
						ctx.fillRect(1+i*tbx,1,tbx-2,tby-2);
						ctx.fillStyle="#000000";
					ctx.textAlign="center";
						ctx.textBaseline="middle";
						ctx.font = "20px Arial";
						ctx.fillText(tes[i],i*tbx+0.5*tbx,tby/2);
					if(mousepressed==1&&Math.abs(mousex-(i*tbx+0.5*tbx))<tbx/2&&Math.abs(mousey-(tby/2))<tby/2){
					if(i==0&&sele==-1){
						mousepressed=-1;
						if(confirm("areyousure?")){
						//maine.orphanize();
						reeero = maine.parseToJSON();
							var r = prompt("Name?","Untitled");
						download(r,JSON.stringify(reeero));
						//maine.deOrphanize();
					}
					sele=1;
				}
						if(i==1&&sele==-1){
					mousepressed=-1;
					if(confirm("R U SURE?")){
						upload();
					}
					sele=1;
				}
						if(i==2&&sele==-1){
					mousepressed=-1;
					runZubble();
					sele=1;
				}
							}
				}
			}
            function drawSideBar(){
				if(side){
					ctx.fillStyle="#EEEEEE";
					ctx.fillRect(sbx-sbsiz,sby,sbsiz,sbhig);
					ctx.fillStyle="#444444";
						ctx.textAlign="center";
						ctx.textBaseline="middle";
						ctx.font = "20px Arial";
					for(var i=0;i<mbar.length;i++){
						ctx.fillStyle="#AAAAAA";
						ctx.fillRect(sbx-sbsiz,sby+i*sbdy,sbsiz,(1)*sbdy);
						ctx.fillStyle="#000000";
						ctx.fillText(mbar[i].name,sbx-sbsiz/2,sby+(i+0.5)*sbdy);
						if(i==sbar){
							ctx.beginPath();
							ctx.moveTo(sbx-sbsiz,sby+i*sbdy);
							ctx.lineTo(sbx-sbsiz-10,sby+(i+0.5)*sbdy);
							ctx.lineTo(sbx-sbsiz,sby+(i+1)*sbdy);
							ctx.closePath();
						}
                        if(mousepressed==1&&Math.abs(mousex-(sbx-sbsiz*0.5))<sbsiz/2&&Math.abs(mousey-(sby+(i+0.5)*sbdy))<sbdy/2){
							sbar=i;
							}
					}
					var j = 0;
					for(var i=0;i<mbar[sbar].array.length;i++){
						var r = mbar[sbar].array[i];
						ctx.font = "20px Arial";
						ctx.fillStyle="#CCCCCC";
						ctx.fillRect(sbx-sbsiz*2,sby+j*sbdy,sbsiz,(1)*sbdy);
						ctx.fillStyle="#000000";
						ctx.fillText(r.name,sbx-sbsiz*1.5,sby+(j+0.5)*sbdy);
                        if(mousepressed==1&&Math.abs(mousex-(sbx-sbsiz*1.5))<sbsiz/2&&Math.abs(mousey-(sby+(j+0.5)*sbdy))<sbdy/2){
							if(r.open){	
                            r.open=false;
                            }else{
                                r.open=true;
                            }
							mousepressed=2;
							}
						j++;
                        if(r.open){
						for(var k = 0;k<r.set.length;k++){
							//r.set[k]
							ctx.font = "15px Arial";
							ctx.fillStyle="#EEEEEE";

							ctx.fillRect(sbx-sbsiz*2,sby+j*sbdy,sbsiz,(1)*sbdy);
							ctx.fillStyle="#000000";
							ctx.fillText(r.set[k].name,sbx-sbsiz*1.5,sby+(j+0.5)*sbdy);
							
							if(mousepressed==1&&Math.abs(mousex-(sbx-sbsiz*1.5))<sbsiz/2&&Math.abs(mousey-(sby+(j+0.5)*sbdy))<sbdy/2){
								dragged=new element(0,1,mousex,mousey);
								dragged.label=r.set[k].name;
                                dragged.color=r.set[k].color;
                                dragged.js=JSON.parse(JSON.stringify(r.set[k]));
							}
							j++;
						}
                    }
					}
					ctx.fillStyle="#AAAAAA";
					ctx.fill();
				}
			}
            upScr();
            //ALL THIS CODE IS DEPRICATED
            /*function update(){
                head.innerHTML="JASN "+(Math.floor(Math.random()*1000));
                renderElements();
                dragger();
            }
            function addElement(type,xpos,ypos){
                elements.push(new Array(type,-1,new Array(),xpos,ypos,new Array(),xpos,ypos,maxlayer,defsize,true));
            }
            function renderElements(){
                ctx.clearRect(0,0,scrwid,scrhig);
                for(var layer = 0;layer<maxlayer+1;layer++){
                    for(i= 0;i<elements.length;i++){
                        if(elements[i][8]==layer){
                        if(i==selected){
                            if(seldat==1){
                                displayElement(elements[i],1.2,1);
                            }else{
                                displayElement(elements[i],1,2)
                            }
                        }else if(over==i){
                            displayElement(elements[i],0.8,1);   
                        }else{
                            displayElement(elements[i],1,1);
                        }
                        }
                    }
                }
            }
            function setSelection(){
                selected=-1;
                for(var layer = 0;layer<maxlayer;layer++){
                    for(i= 0;i<elements.length;i++){
                        if(elements[i][8]==layer){
                            e=elements[i];
                            if(dist(e[6],e[7],mousex,mousey,e[9])){
                                if(dist(e[6],e[7],mousex,mousey,e[9]-selrad)){
                                    seldat=1;
                                }else{
                                    seldat=-1;
                                }
                                selected=i;
                            }
                        }
                    }
                }
            }
            function setOver(){
                over=-1;
                for(var layer = 0;layer<maxlayer;layer++){
                    for(i= 0;i<elements.length;i++){
                        if(elements[i][8]==layer){
                            e=elements[i];
                            if(i!=picked){
                                if(dist(e[6],e[7],mousex,mousey,e[9])){
                                    over=i;
                                }
                            }
                        }
                    }
                }
            }
            function drop(p,c){
                elements[p][2].push(c);
                elements[c][1]=p;
                elements[c][3]=-elements[p][6]+elements[c][6];
                elements[c][4]=-elements[p][7]+elements[c][7];
                elements[c][8]=elements[p][8]+1;
                d=dist2(elements[p][6],elements[p][7],elements[c][6],elements[c][7]);
                    if(elements[p][9]<d+elements[c][9]){
                    elements[p][9] = d+elements[c][9];
                }
            }
            var pik=0;
            function dragger(){
                if(selected!=-1){
                    if(seldat==1){
                        if(mousepressed==1){
                            picked=selected;
                        }
                    }
                }
                if(picked!=-1){
                    if(pik==0){
                        elements[picked][8]=maxlayer;
                        p=elements[picked][1];
                        if(p!=-1){
                            arr = elements[p][2];
                            index = arr.indexOf(picked);
                            if(index>-1){
                                elements[p][2].splice(index,1)
                            }
                            elements[picked][1]=-1;
                        }
                        //updatelayers();
                        pik=1;
                    }
                    if(mousepressed==1){
                        elements[picked][6]+=mdx;
                        elements[picked][7]+=mdy;
                        elements[picked][3]+=mdx;
                        elements[picked][4]+=mdy;
                        updateAbsPos(picked);
                    }
                    if(mousepressed==2){
                        if(over!=-1){
                           drop(over,picked);
                            updateMaxLayer();    
                        }else{
                           elements[picked][8]=0;
                            elements[picked][1]=-1;
                           }
                        if(pik == 1){
                            updateAbsPos(picked);
                            pik=0;
                        }
                        picked=-1;
                    }
                }
            }
            function displayElement(e,t,s){
                if(e[0] == 1){
                    ctx.fillStyle= tint(colorblocks[0],t);
                    ctx.strokeStyle=tint(colorblocks[0],0.6*s);
                    ctx.lineWidth = s*2;
                    ctx.beginPath();
                    ctx.arc(e[6],e[7],e[9],0,2*Math.PI);
                    ctx.fill();
                    ctx.stroke();
                }
            }
            
            function updateMaxLayer(){
                for(i= 0;i<elements.length;i++){
                     if(elements[i][8]>=maxlayer){
                         maxlayer=elements[i][8]+1;
                     }   
                }
            }
            function updateAbsPos(i){
                    //if(elements[i][8]==0){
                        for(k = 0;k<elements[i][2].length;k++){
                            upabspos(elements[i][2][k]);
                        }       
                    //}
            }
            function upabspos(i){
                p=elements[i][1];
                elements[i][6]=elements[p][6]+elements[i][3];
                elements[i][7]=elements[p][7]+elements[i][4];
                for(var k = 0;k<elements[i][2].length;k++){
                    upabspos(elements[i][2][k]);   
                }
            }
*/
            function dist(x,y,x2,y2,r){
                if(Math.pow((x-x2),2)+Math.pow((y-y2),2)<Math.pow(r,2)){
                    return true;
                }else{
                    return false;
                }
            }
            function dist2(x,y,x2,y2){
                return (Math.pow((Math.pow((x-x2),2)+Math.pow((y-y2),2)),0.5));
            }
            function tint(color,tint){
                return("rgb("+color[0]*tint+","+color[1]*tint+","+color[2]*tint+")");
            }
        
        </script>
        
        
        
    </body>
</html>