<!DOCTYPE html>
<html>
    <head>
        <title id="title">THIS IS GOOD</title>
        <link id="icon" rel="icon" href="icon1.png">
        <meta name="viewport" content="width=device-width,user-scalable=no">

    </head>
    <body style="margin:0;padding:0;" onresize="upScr()">
        <!--<h1 id="head">JASN 188</h1>
        <p><i>There are some <strong>bugs</strong> in here</i></p>
        <p id = "output"></p>
        <button id ="test">TEST</button><br/>-->
        <canvas id="main" width="500" height="500" style="margin:0;padding:0;">
        </canvas>
        <script type="text/javascript" src="d_html.json"></script>
        <script>
            var main = document.getElementById("main");
            var ctx = main.getContext("2d");
            var scrwid =window.innerWidth-10;
            var scrhig=window.innerHeight-10;
            main.getAttributeNode("width").value=scrwid;
            main.getAttributeNode("height").value=scrhig;
            
            var title = document.getElementById("title");
            var icon = document.getElementById("icon");
            /*var head = document.getElementById("head");
            var output = document.getElementById("output");
            var testButton = document.getElementById("test");
            testButton.onclick = function test(){
                //addElement(1,200,200);
                //updateMaxLayer();
                addElement(maine,1,1,0,0);
            }*/
            icond=1;
			function upScr(){
				 scrwid =window.innerWidth-10;
            scrhig=window.innerHeight-10;
				main.getAttributeNode("width").value=scrwid;
            main.getAttributeNode("height").value=scrhig;
				sbhig=scrhig;
			sbx=scrwid;
				
				
				update();
			}
            var iconchanger=setInterval(function(){
                icon.getAttributeNode("href").value = "icon"+icond+".png";
                icond=(icond%2)+1;
            },1000);
            var mousex;
            var mousey;
            var mdx = 0;
            var mdy = 0;
            var mousepressed=0;
            var upmos=0;
             var cdlay = 100;
            var dat = new Date();
            var time= dat.getTime;
            function setMouse(event){
                var dt = new Date().getTime()-time;
                if(mousepressed==1&&dt>cdlay){
                mousepressed=2;
                    //console.log(mousepressed+" "+dt);
                }
                if(mousepressed==3&&dt>cdlay){
                mousepressed=4;
                    //console.log(mousepressed+" "+dt);
                }
                mdx = event.layerX-mousex;
                mdy = event.layerY-mousey;
                mousex = event.layerX;
                mousey = event.layerY;
                //if(mousepressed==1||upmos<10){
                if(picked==-1){
                    //setSelection();
                }else{
                    //setOver();
                }
                //output.innerHTML="Mouse: " +mousex+ " "+mousey
                /*if(selected!=-1){
                   output.innerHTML+=" Parent: "+ elements[selected][1];
                    output.innerHTML+=" Children: " +elements[selected][2];
                    output.innerHTML+=" Layer: "+ elements[selected][8];
                }*/
                update();
                title.innerHTML= Math.floor(Math.random()*1000)+" Ways to Fail"
                //}
            }
            function setTouch(event){
                event.preventDefault();
                var dt = new Date().getTime()-time;
                if(mousepressed==1&&dt>cdlay){
                mousepressed=2;
                    //console.log(mousepressed+" "+dt);
                }
                if(mousepressed==3&&dt>cdlay){
                mousepressed=4;
                    //console.log(mousepressed+" "+dt);
                }
                var tou = event.changedTouches;
                if(tou.length==1){
                    var e = main.getBoundingClientRect();
                mdx = tou[0].pageX-e.left-mousex;
                mdy = tou[0].pageY-e.top-mousey;
                mousex = tou[0].pageX-e.left;
                mousey = tou[0].pageY-e.top;
                }
                //if(mousepressed==1||upmos<10){
                if(picked==-1){
                    //setSelection();
                }else{
                    //setOver();
                }
                //output.innerHTML="Mouse: " +mousex+ " "+mousey
                /*if(selected!=-1){
                   output.innerHTML+=" Parent: "+ elements[selected][1];
                    output.innerHTML+=" Children: " +elements[selected][2];
                    output.innerHTML+=" Layer: "+ elements[selected][8];
                }*/
                update();
                title.innerHTML= Math.floor(Math.random()*1000)+" Ways to Fail"
                //}
            }
            function click(event){
                var dt = new Date().getTime()-time;
                if(mousepressed==0){
                mousepressed=1;
                }
                if(dt<cdlay){
                mousepressed=3;
                }
                update();
                
                time=new Date().getTime();
                //console.log(mousepressed+" "+dt);
                //console.log("click")
            }
            ///MOUSEPRESSED AS FOLLOWS:
            ///0: Not pressed
            ///1: Just Clicked
            ///2: Held Once
            ///3: Clicked twice
            ///4: Held Twice
            function cluck(event){
                var dt = time-dat.getTime();
                upmos=0;
                mousepressed=0;
                //if(mousepressed==1){
                //mousepressed=0;
                //}
                //if(mousepressed==3){
                //mousepressed=0;
                //}
                update();
                time=new Date().getTime();
                //console.log("cluck")
            }
            function tap(event){
                var tou = event.changedTouches;
                if(tou.length==1){
                    var e = main.getBoundingClientRect();
                mdx = tou[0].pageX-e.left-mousex;
                mdy = tou[0].pageY-e.top-mousey;
                mousex = tou[0].pageX-e.left;
                mousey = tou[0].pageY-e.top;
                }
                event.preventDefault();
                var dt = new Date().getTime()-time;
                if(mousepressed==0){
                mousepressed=1;
                }
                if(dt<cdlay){
                mousepressed=3;
                }
                update();  
                time=new Date().getTime();
            }
            function untap(event){
                event.preventDefault();
                var dt = time-dat.getTime();
                upmos=0;
                mousepressed=0;
                time=new Date().getTime();
                update();
                update();
                //console.log("cluck")
            }
            main.addEventListener('mousemove',setMouse);
            main.addEventListener('mousedown',click);
            main.addEventListener('mouseup',cluck)
            main.addEventListener('touchmove',setTouch,false);
            main.addEventListener('touchstart',tap,false);
            main.addEventListener('touchend',untap,false)
            offcan = document.createElement('canvas');
            offcan.width = scrwid;
            offcan.height= scrhig;
            offctx = offcan.getContext('2d');
            /*function renderOffCan(i){
                for(k=0;k<elements[i][2].length;k++){
                    rendChild(i);
                }
            }*/
            /*function rendChild(i){
                p=elements[i][1];
                for(var k = 0;k<elements[i][2].length;k++){
                    rendChild(elements[i][2][k]);   
                }
            }*/
            
            
            var elements = new Array(0);
            var maxlayer = 0;
            var selected;
            var picked;
            var over;
            var seldat =-1;
            var selrad = 10;
            var defsize = 25;
            var ddde=10;
            var colorblocks = new Array([100,150,200],[200,100,150]);
			var parent=null;
            
            //THE STRUCTURE FOR THE Element OBject
            //Absolutes then the easily changed...
            // 0type, 1parent, 2children[], 3local xpos, 4local ypos, 5connections[],  6abs xpos, 7abs ypos, 8layer , 9size,10 open?
            
            
            
            //OBjECT
            function element(i,type,xpos,ypos){
                this.x = xpos;
                this.y = ypos;
				this.close = false;
				this.xv =0;
				this.yv=0;
                this.absx = xpos;
                this.absy = ypos;
                this.type = type;
                this.parent = null;
                this.children = [];
                this.id = i;
                this.color = 0;
                this.tint =1;
                this.bold = 1;
                this.layer=0;
                this.size = defsize;
                this.open = true;
                this.connections = [];
                this.render = function(){
                    var t = this.tint;
                    var s = this.bold;
                    ctx.fillStyle= tint(colorblocks[this.color],t);
                    ctx.strokeStyle=tint(colorblocks[this.color],0.6*s);
                    ctx.lineWidth = s*2;
                    ctx.beginPath();
                    ctx.arc(this.absx,this.absy,this.size,0,2*Math.PI);
                    ctx.fill();
                    ctx.stroke();
					if(!this.close){
                    for(var i =0;i<this.children.length;i++){
                        this.children[i].render();
                    }
                    }else{
                        ctx.font="30px Arial";
                        ctx.fillStyle = tint(colorblocks[this.color],0);
						ctx.fillText(this.children.length,this.absx-10,this.absy+10);
					}
                    
                };
                this.add = function(e){
                    this.children.push(e);
                };
				this.getSelection = function(){
					if(dist(this.absx,this.absy,mousex,mousey,this.size)){
						selected=this;
					}
                    if(!this.close)
					for(i = 0;i<this.children.length;i++){
						this.children[i].getSelection();
					}
				}
				this.move = function(dx,dy){
					this.absx += dx;
					this.absy += dy;
					for(var i =0;i<this.children.length;i++){
                        this.children[i].updatePos();
                    } 
				}
                this.togClose=function(){
                    if(this.close){
                        this.close=false;
                        this.updateSize();
                    }else{
                        this.close=true;
                    }
                }
				this.shrinkWrap=function(){
                    if(!this.close)
					for(var i =0;i<this.children.length;i++){
                        this.children[i].shrinkWrap();
                    } 
				}
				this.updatePos = function(){
					this.absx = this.parent.absx + this.x;
					this.absy = this.parent.absy + this.y;
					for(var i =0;i<this.children.length;i++){
                        this.children[i].updatePos();
                    } 
				}
                this.updateSize=function(){
                    //this.parent.size=dist2(this.absx,this.absy,this.parent.absx,this.parent.absy)+(this.size)+ddde;
                    if(!this.close){
                    var maxsize = defsize;
                    var chose=-1;
                    for(var i =0;i<this.children.length;i++){
                        this.children[i].updateSize();
                        var c = this.children[i];
                        if(dist2(this.absx,this.absy,c.absx,c.absy)+(c.size)+ddde>maxsize){
                           maxsize=dist2(this.absx,this.absy,c.absx,c.absy)+(c.size)+ddde;
                            
                           }
                    } 
                    this.size=maxsize;
                    }else{
                        this.size=defsize;
                    }
                }
                this.updateChildSize = function(){
                    for(var i =0;i<this.children.length;i++){
                        this.children[i].updateSize();
                    } 
                }
				this.findParent = function(e){
					parent=null;
					e.recFindParent(this);
					if(parent!=null){
						this.parent = parent;
						parent.children.push(this);
						/*if(!dist(this.absx,this.absy,parent.absx,parent.absy,(parent.size-this.size))){
                         this.parent.size=dist2(this.absx,this.absy,parent.absx,parent.absy)+(this.size)+ddde;   
                        }*/
						this.x = -this.parent.absx+this.absx;
						this.y = -this.parent.absy+this.absy;
					}
				}
				this.recFindParent = function(c){
					if(this!=c)
					   if(dist(this.absx,this.absy,mousex,mousey,(this.size))){
					   parent = this;
                        if(!this.close)
						for(var i =0;i<this.children.length;i++){
                        this.children[i].recFindParent(c);
                    	} 
					}
				}
				this.removeParent = function(){
					this.parent.children.splice(this.parent.children.indexOf(this),1);
					this.parent = null;
				}
            }
            var maine = new element(0,1,250,250);
            maine.size = 250;
            maine.color = 1;
            //console.log(bob.type);
            
            //TYPE STRUCTURES
            // type: 1 
            //  A basic circle
            /**for(var i = 0; i < 100; i++){
                elements[i] = new Array(Math.random()*100,Math.random()*100);
            }
            for(var i = 0; i < 100; i++){
                ctx.fillStyle ='rgb(0,0,'+i*10+')';
                ctx.beginPath();
                ctx.arc(elements[i][0]+250,elements[i][1]+250,10,0,2*Math.PI);
                ctx.fill();
                ctx.stroke();
            }**/
            //var uptimer = setInterval(function(){update()},100);
            var upmostim = setInterval(function(){upmos++;},100);
			
			
			////UPDATE///////////////////////////
            function update(){
                //head.innerHTML="JASN "+(Math.floor(Math.random()*1000));
                maine.render();
				//selected= maine;
				drawSideBar();
				dragger();
				maine.updateChildSize();
            }
            
			
			
			
			
			
            function addElement(parent,i,type,x,y){
                var e = new element(i,type,x,y);
                e.absx = maine.absx+x;
                e.absy = maine.absy+y;
				e.parent = parent;
                maine.add(e);
            }
			function dragElement(e){
				e.move(mdx,mdy);
			}
			dragged = null;
			function dragger(){
                if(mousepressed==3){
                    selected=null;
				    maine.getSelection();
				    if(selected != maine&&selected!=null){
				        selected.togClose();
                        mousepressed=4;
                    }
                }
                if(mousepressed==0&&dragged==null){
                    if(selected!=null)
                    selected.tint=1;
                    selected=null;
                    maine.getSelection();
                    if(selected!=null)
                    selected.tint=1.2;
                }
				if(mousepressed==2&&dragged==null){
				selected=null;
				maine.getSelection();
				if(selected != maine&&selected!=null){
				dragged=selected;
                    dragged.tint=1.1;
				dragged.removeParent();}
				}
				if(dragged!=null){
				   dragElement(dragged);
				    dragged.render();
                    if(selected!=null)
                    selected.bold=1;
                    selected=null;
                    maine.getSelection();
                    if(selected!=null)
                    selected.bold=2;
				}
				if(mousepressed==0&&dragged!=null){
                    if(selected!=null)
                    selected.bold=1;
					dragged.findParent(maine);
					dragged.render();
					dragged=null;
				}
			}
			///////SIDE BAR////////////////////
			var sbsiz = 100;
			var sbdy=30;
			var sbhig=scrhig-20;
			var sbx=scrwid-20;//THe RIGHT SIDE
			var sby=0;
			var side=true;
			var mbar = [];
			var sbar = 0;
			mbar.push(JSON.parse(d_html));
			
			
            function drawSideBar(){
				if(side){
					ctx.fillStyle="#EEEEEE";
					ctx.fillRect(sbx-sbsiz,sby,sbsiz,sbhig);
					ctx.fillStyle="#444444";
						ctx.textAlign="center";
						ctx.textBaseline="middle";
						ctx.font = "20px Arial";
					for(var i=0;i<mbar.length;i++){
						ctx.fillStyle="#AAAAAA";
						ctx.fillRect(sbx-sbsiz,sby+i*sbdy,sbsiz,(1)*sbdy);
						ctx.fillStyle="#000000";
						ctx.fillText(mbar[i].name,sbx-sbsiz/2,sby+(i+0.5)*sbdy);
						if(i==sbar){
							ctx.beginPath();
							ctx.moveTo(sbx-sbsiz,sby+i*sbdy);
							ctx.lineTo(sbx-sbsiz-10,sby+(i+0.5)*sbdy);
							ctx.lineTo(sbx-sbsiz,sby+(i+1)*sbdy);
							ctx.closePath();
						}
					}
					var j = 0;
					for(var i=0;i<mbar[sbar].array.length;i++){
						var r = mbar[sbar].array[i];
						ctx.font = "20px Arial";
						ctx.fillStyle="#CCCCCC";
						ctx.fillRect(sbx-sbsiz*2,sby+j*sbdy,sbsiz,(1)*sbdy);
						ctx.fillStyle="#000000";
						ctx.fillText(r.name,sbx-sbsiz*1.5,sby+(j+0.5)*sbdy);
						j++;
						for(var k = 0;k<r.set.length;k++){
							//r.set[k]
							ctx.font = "15px Arial";
							ctx.fillStyle="#EEEEEE";

							ctx.fillRect(sbx-sbsiz*2,sby+j*sbdy,sbsiz,(1)*sbdy);
							ctx.fillStyle="#000000";
							ctx.fillText(r.set[k].name,sbx-sbsiz*1.5,sby+(j+0.5)*sbdy);
							j++;
						}
					}
					ctx.fillStyle="#AAAAAA";
					ctx.fill();
				}
			}
            
            //ALL THIS CODE IS DEPRICATED
            /*function update(){
                head.innerHTML="JASN "+(Math.floor(Math.random()*1000));
                renderElements();
                dragger();
            }
            function addElement(type,xpos,ypos){
                elements.push(new Array(type,-1,new Array(),xpos,ypos,new Array(),xpos,ypos,maxlayer,defsize,true));
            }
            function renderElements(){
                ctx.clearRect(0,0,scrwid,scrhig);
                for(var layer = 0;layer<maxlayer+1;layer++){
                    for(i= 0;i<elements.length;i++){
                        if(elements[i][8]==layer){
                        if(i==selected){
                            if(seldat==1){
                                displayElement(elements[i],1.2,1);
                            }else{
                                displayElement(elements[i],1,2)
                            }
                        }else if(over==i){
                            displayElement(elements[i],0.8,1);   
                        }else{
                            displayElement(elements[i],1,1);
                        }
                        }
                    }
                }
            }
            function setSelection(){
                selected=-1;
                for(var layer = 0;layer<maxlayer;layer++){
                    for(i= 0;i<elements.length;i++){
                        if(elements[i][8]==layer){
                            e=elements[i];
                            if(dist(e[6],e[7],mousex,mousey,e[9])){
                                if(dist(e[6],e[7],mousex,mousey,e[9]-selrad)){
                                    seldat=1;
                                }else{
                                    seldat=-1;
                                }
                                selected=i;
                            }
                        }
                    }
                }
            }
            function setOver(){
                over=-1;
                for(var layer = 0;layer<maxlayer;layer++){
                    for(i= 0;i<elements.length;i++){
                        if(elements[i][8]==layer){
                            e=elements[i];
                            if(i!=picked){
                                if(dist(e[6],e[7],mousex,mousey,e[9])){
                                    over=i;
                                }
                            }
                        }
                    }
                }
            }
            function drop(p,c){
                elements[p][2].push(c);
                elements[c][1]=p;
                elements[c][3]=-elements[p][6]+elements[c][6];
                elements[c][4]=-elements[p][7]+elements[c][7];
                elements[c][8]=elements[p][8]+1;
                d=dist2(elements[p][6],elements[p][7],elements[c][6],elements[c][7]);
                    if(elements[p][9]<d+elements[c][9]){
                    elements[p][9] = d+elements[c][9];
                }
            }
            var pik=0;
            function dragger(){
                if(selected!=-1){
                    if(seldat==1){
                        if(mousepressed==1){
                            picked=selected;
                        }
                    }
                }
                if(picked!=-1){
                    if(pik==0){
                        elements[picked][8]=maxlayer;
                        p=elements[picked][1];
                        if(p!=-1){
                            arr = elements[p][2];
                            index = arr.indexOf(picked);
                            if(index>-1){
                                elements[p][2].splice(index,1)
                            }
                            elements[picked][1]=-1;
                        }
                        //updatelayers();
                        pik=1;
                    }
                    if(mousepressed==1){
                        elements[picked][6]+=mdx;
                        elements[picked][7]+=mdy;
                        elements[picked][3]+=mdx;
                        elements[picked][4]+=mdy;
                        updateAbsPos(picked);
                    }
                    if(mousepressed==2){
                        if(over!=-1){
                           drop(over,picked);
                            updateMaxLayer();    
                        }else{
                           elements[picked][8]=0;
                            elements[picked][1]=-1;
                           }
                        if(pik == 1){
                            updateAbsPos(picked);
                            pik=0;
                        }
                        picked=-1;
                    }
                }
            }
            function displayElement(e,t,s){
                if(e[0] == 1){
                    ctx.fillStyle= tint(colorblocks[0],t);
                    ctx.strokeStyle=tint(colorblocks[0],0.6*s);
                    ctx.lineWidth = s*2;
                    ctx.beginPath();
                    ctx.arc(e[6],e[7],e[9],0,2*Math.PI);
                    ctx.fill();
                    ctx.stroke();
                }
            }
            
            function updateMaxLayer(){
                for(i= 0;i<elements.length;i++){
                     if(elements[i][8]>=maxlayer){
                         maxlayer=elements[i][8]+1;
                     }   
                }
            }
            function updateAbsPos(i){
                    //if(elements[i][8]==0){
                        for(k = 0;k<elements[i][2].length;k++){
                            upabspos(elements[i][2][k]);
                        }       
                    //}
            }
            function upabspos(i){
                p=elements[i][1];
                elements[i][6]=elements[p][6]+elements[i][3];
                elements[i][7]=elements[p][7]+elements[i][4];
                for(var k = 0;k<elements[i][2].length;k++){
                    upabspos(elements[i][2][k]);   
                }
            }
*/
            function dist(x,y,x2,y2,r){
                if(Math.pow((x-x2),2)+Math.pow((y-y2),2)<Math.pow(r,2)){
                    return true;
                }else{
                    return false;
                }
            }
            function dist2(x,y,x2,y2){
                return (Math.pow((Math.pow((x-x2),2)+Math.pow((y-y2),2)),0.5));
            }
            function tint(color,tint){
                return("rgb("+color[0]*tint+","+color[1]*tint+","+color[2]*tint+")");
            }
        
        </script>
        
        
        
    </body>
</html>